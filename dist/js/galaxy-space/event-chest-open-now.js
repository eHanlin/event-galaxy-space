define(["jquery","ajax","confirmPopup","eventStatusDo"],($,ajax,confirmPopup,eventStatusDo)=>(chest,targets)=>{let seconds;ajax("GET",`http://localhost:8080/chest/coolDownTime/${chest.id}`).then(data=>(seconds=data.content,console.log(seconds),ajax("GET","http://localhost:8080/chest/condition/openImmediately"))).then(data=>{let consume=data.content.content,deductGems=Math.ceil(seconds/3600)*consume.everyHourDeductGems;confirmPopup.dialog(`<h2>立即開啟寶箱需花費${deductGems}個寶石</h2><h3>確定要立即開啟寶箱嗎？<h3>`,()=>{ajax("PUT",`http://localhost:8080/chest/open/immediately/${chest.id}`,{deductGems:deductGems}).then(data=>{let originalGems=$("#gems").text(),finalGems=data.content.finalGems,insufficientGems=originalGems-deductGems;if(insufficientGems<0)return confirmPopup.confirm(`你的寶石不足${-1*insufficientGems}個`,"欠一屁股債了~ 快做題吧 !",()=>{}),!1;ajax("PUT",`http://localhost:8080/chest/status/${chest.id}`,{status:"OPEN"}).then(eventStatusDo.open.bind(eventStatusDo.open,chest,targets)),require(["eventCountUp"],eventCountUp=>{eventCountUp("gems",originalGems,finalGems),window.location.reload()})})},()=>{})})});