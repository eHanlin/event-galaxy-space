"use strict";define(["jquery","ajax","confirmPopup"],function($,ajax,confirmPopup){var eventChestUpgrade={ask:function(chest,targets){var upLevel=chest.level+1;ajax("GET","/chest/condition/level"+upLevel,null).then(function(jsonData){var data=jsonData.content.content,needCoins=data.coins,needGems=data.gems,content='\n          <div class="confirm-grid-upgrade-container">\n            <div class="image-block1">\n              <img class="image-block1-chest" src="https://d220xxmclrx033.cloudfront.net/event-space/img/chest/chest'+upLevel+'.png">\n            </div>\n            <div class="content-block1">\n              <span>Lv'+chest.level+" -> Lv"+upLevel+'</span>\n            </div>\n            <div class="content-block2">\n              你確定要花費 <span class="confirm-popup-info"> '+needCoins+'\n              <span class="confirm-popup-warning">個 e 幣</span>、 '+needGems+' <span class="confirm-popup-warning">個 寶石 </span></span>\n              升級至 Lv'+upLevel+' 寶箱嗎？\n            </div>\n            <div class="content-block3">請注意： 高等的寶箱有更好的寶藏等著你，但升級寶箱有一定失敗的機率喔!</div>\n          </div>\n        ';confirmPopup.dialog(content,eventChestUpgrade.process.bind(eventChestUpgrade.process,chest))})},process:function(chest){var upLevel=chest.level+1,loadingTarget=$("#loading");loadingTarget.css("display",""),ajax("GET","/chest/condition/level"+upLevel,null).then(function(jsonData){var levelInfo=jsonData.content.content,coins=levelInfo.coins,gems=levelInfo.gems;return ajax("GET","/chest/checkBalance?coins="+coins+"&gems="+gems,null)}).then(function(jsonData){var insufficientMessage=jsonData.content;if(insufficientMessage){return confirmPopup.ok("Oooooops 餘額不足喔！",insufficientMessage),loadingTarget.css("display","none"),$.Deferred().reject().promise()}return ajax("PUT","/currencyBank/chest/levelUp/"+chest.id)}).then(function(jsonData){var content=jsonData.content;if(content.isActivation&&"false"===content.isActivation)confirmPopup.ok("Oooooops！ 無法再升級囉！",'你目前還不是銀河探險隊的正式隊員，\n            馬上前往購買課程成為正式隊員再回來繼續升級寶箱拿獎品吧！ \n            <br/><a href="https://test.ehanlin.com.tw/courses_map.html">課程連結</a>');else if(content.isLevelUpSucceeded&&"true"===content.isLevelUpSucceeded)confirmPopup.ok("Oooooops 此寶箱已經升級過囉","");else{var result=eventChestUpgrade.determineLevelUpSuccess(content,chest);confirmPopup.image(result.text,result.gif,function(){var spendCoins=result.coins,spendGems=result.gems,finalCoins=parseInt($("#coins").text())-spendCoins,finalGems=parseInt($("#gems").text())-spendGems;require(["eventChestGet","eventCountUp"],function(eventChestGet,eventCountUp){eventChestGet(),eventCountUp("coins",parseInt($("#coins").text()),finalCoins),eventCountUp("gems",parseInt($("#gems").text()),finalGems)})})}}).done(function(){loadingTarget.css("display","none")})},determineLevelUpSuccess:function(content,chest){var result=content[0],upLevel=chest.level+1;return result&&"true"===result.memo.levelUpSuccess?(result.text="升級成功",result.gif='<image class="confirm-popup-chest-img" src="https://d220xxmclrx033.cloudfront.net/event-space/img/chest/upgradeStatus/upgradeSuccess'+upLevel+'.gif">'):(result.text="升級失敗",result.gif='<image class="confirm-popup-chest-img" src="https://d220xxmclrx033.cloudfront.net/event-space/img/chest/upgradeStatus/upgradeFail'+chest.level+'.gif">'),result}};return eventChestUpgrade});