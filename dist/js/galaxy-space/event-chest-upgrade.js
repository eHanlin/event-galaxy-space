define(["jquery","ajax","confirmPopup"],($,ajax,confirmPopup)=>{let eventChestUpgrade={tip:(chest,targets)=>{let upLevel=chest.level+1;ajax("GET",`http://localhost:8080/chest/condition/level${upLevel}`,null).then(jsonData=>{let data=jsonData.content.content,needCoins=data.coins,needGems=data.gems,content=`\n          <div class="confirm-grid-upgrade-container">\n            <div class="image-block1">\n              <img class="image-block1-chest" src="./img/chest/chest${upLevel}.png">\n            </div>\n            <div class="content-block1">\n              <span>Lv${chest.level} -> Lv${upLevel}</span>\n            </div>\n            <div class="content-block2">\n              你確定要花費 <span class="confirm-popup-info"> ${needCoins}\n              <span class="confirm-popup-warning">個 e 幣</span>、 ${needGems} <span class="confirm-popup-warning">個 寶石 </span></span>\n              升級至 Lv${upLevel} 寶箱嗎？\n            </div>\n            <div class="content-block3">請注意： 高等的寶箱有更好的寶藏等著你，但升級寶箱有一定失敗的機率喔!</div>\n          </div>\n        `;confirmPopup.dialog(content,eventChestUpgrade.process.bind(eventChestUpgrade,chest,targets))})},process:(chest,targets)=>{let upLevel=chest.level+1;ajax("GET",`http://localhost:8080/chest/checkBalance/level${upLevel}`,null).then(jsonData=>{let insufficientMessage=jsonData.content;if(insufficientMessage){let title="Oooooops 餘額不足喔！";return confirmPopup.ok(title,insufficientMessage),$.Deferred().reject().promise()}return ajax("PUT",`http://localhost:9090/currencyBank/chest/levelUp/${chest.id}`,{level:upLevel})}).then(jsonData=>{let gif;gif=jsonData.content[0].source.indexOf("true")>0?`<image class="confirm-popup-chest-gif" src="./img/chest/upgradeStatus/upgradeSuccess${upLevel}.gif">`:`<image class="confirm-popup-chest-gif" src="./img/chest/upgradeStatus/upgradeFail${upLevel}.gif">`,confirmPopup.ok("升級成功",gif,()=>{window.location.reload()}),targets.platformChest.attr("src",`./img/chest/chest${upLevel}.png`),targets.platformChest.attr("class",`chest${upLevel}`),targets.upgradeBtn.css("display","none"),targets.startBtn.css("left","27%")})}};return eventChestUpgrade});